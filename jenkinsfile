pipeline {
    agent any

    stages {
        //Continuous Integration
        stage('Build') {
            steps {
                sh 'mvn clean package -DskipTests=true'
            }
        }
        stage('Test') {
            steps {
                sh 'mvn test'
            }
        }
        //Continuous Delivery
        stage('Docker Build & Push') {
            steps {
                withDockerRegistry(credentialsId: 'docker', url: "") {
                    sh 'docker build -t souhirkaroui/ProjetFLSGTC .'
                    sh 'docker tag souhirkaroui/ProjetFLSGTC souhirks/fullstack'
                    sh 'docker push souhirks/fullstack'
               }
            }
          }
       // Continuous Deployment
      //    stage('Deploy with Docker') {
      //      steps {
      //         withDockerRegistry(credentialsId: 'docker', url: "") {
      //              sh 'docker -H ssh://ubuntu@172.31.37.218 rm -f full'
      //              sh 'docker -H ssh://ubuntu@172.31.37.218 run -d --name full -p 8080:8080 souhirks/fullstack'
       //         }
      //      }  
     //   }
    // Continuous Deployment
       stage('Deploy to Kubernetes') {
            steps {
                withKubeConfig([credentialsId: 'kubeconfig']) { 
                    script {
                       
                        sh 'kubectl apply -f mysql-deployment.yml'
                        sh 'kubectl apply -f verifmail-deployment.yml'
                        sh 'kubectl apply -f frontend-deployment.yml'

                       // sh 'kubectl apply -f compare-app-service.yml'
                      //  sh 'kubectl apply -f compare-app-ingress.yml'
                    }
                }
          }
      }   
         
    }
} 
